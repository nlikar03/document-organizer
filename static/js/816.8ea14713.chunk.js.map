{"version":3,"file":"static/js/816.8ea14713.chunk.js","mappings":"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","sources":["clientDownloads.js"],"sourcesContent":["import JSZip from 'jszip';\r\nimport { PDFDocument, rgb, StandardFonts, degrees } from 'pdf-lib';\r\nimport * as XLSX from 'xlsx';\r\nimport { getFileFromIndexedDB } from './indexedDBHelper';\r\n\r\nexport const addWatermarkToPDF = async (pdfBytes, watermarkText) => {\r\n  try {\r\n    const pdfDoc = await PDFDocument.load(pdfBytes);\r\n    const pages = pdfDoc.getPages();\r\n    if (pages.length === 0) return pdfBytes;\r\n\r\n    const page = pages[0];\r\n    const { width, height } = page.getSize();\r\n    const rotation = page.getRotation().angle % 360;\r\n\r\n    const font = await pdfDoc.embedFont(StandardFonts.HelveticaBold);\r\n    const fontSize = 20;\r\n    const margin = 30;\r\n    const textWidth = font.widthOfTextAtSize(watermarkText, fontSize);\r\n    const textHeight = fontSize; \r\n\r\n    let x, y;\r\n\r\n    // Logic for VISUAL Top-Right based on internal rotation\r\n    switch (rotation) {\r\n      case 90:\r\n        x = margin + textHeight; \r\n        y = height - margin - textWidth;\r\n        break;\r\n      case 180:\r\n        x = margin + textWidth;\r\n        y = margin;\r\n        break;\r\n      case 270:\r\n        x = width - margin - textHeight;\r\n        y = margin + textWidth;\r\n        break;\r\n      case 0:\r\n      default:\r\n        x = width - textWidth - margin;\r\n        y = height - margin - textHeight;\r\n        break;\r\n    }\r\n\r\n    page.drawText(watermarkText, {\r\n      x,\r\n      y,\r\n      size: fontSize,\r\n      font,\r\n      color: rgb(1, 0, 0),\r\n      rotate: degrees(rotation), \r\n    });\r\n\r\n    return await pdfDoc.save();\r\n  } catch (error) {\r\n    console.error('Watermark error:', error);\r\n    return pdfBytes;\r\n  }\r\n};\r\n\r\n// Helper: get the folder ID regardless of whether file is a direct upload or AI-classified\r\nconst getFolderId = (result) => {\r\n  // AI-classified files have suggestedFolder.id\r\n  // Direct uploads have folderId (string)\r\n  return result.suggestedFolder?.id ?? result.folderId;\r\n};\r\n\r\nexport const downloadZipClientSide = async (finalResults, folders) => {\r\n  const zip = new JSZip();\r\n  \r\n  const folderPaths = {};\r\n  for (const folder of folders) {\r\n    const parts = [];\r\n    const ids = folder.id.split('.');\r\n    for (let i = 0; i < ids.length; i++) {\r\n      const fid = ids.slice(0, i + 1).join('.');\r\n      const f = folders.find(x => x.id === fid);\r\n      if (f) parts.push(f.name);\r\n    }\r\n    const path = parts.join('/');\r\n    folderPaths[folder.id] = path;\r\n    zip.folder(path);\r\n  }\r\n  \r\n  for (const result of finalResults) {\r\n    const file = await getFileFromIndexedDB(result.fileName);\r\n    if (!file) continue;\r\n    \r\n    let fileBytes = await file.arrayBuffer();\r\n    \r\n    if (file.name.toLowerCase().endsWith('.pdf')) {\r\n      fileBytes = await addWatermarkToPDF(fileBytes, result.docCode);\r\n    }\r\n    \r\n    const base = file.name.substring(0, file.name.lastIndexOf('.'));\r\n    const ext = file.name.substring(file.name.lastIndexOf('.'));\r\n    const newName = `${String(result.fileNumber).padStart(3, '0')}_${base}${ext}`;\r\n\r\n    // FIX: use getFolderId() to support both direct uploads and AI-classified files\r\n    const folderId = getFolderId(result);\r\n    const folderPath = folderPaths[folderId];\r\n    if (!folderPath) {\r\n      console.warn(`No folder path found for folderId \"${folderId}\" on file \"${result.fileName}\" — skipping.`);\r\n      continue;\r\n    }\r\n    const path = `${folderPath}/${newName}`;\r\n    \r\n    zip.file(path, fileBytes);\r\n  }\r\n  \r\n  const blob = await zip.generateAsync({ type: 'blob' });\r\n  const url = window.URL.createObjectURL(blob);\r\n  const a = document.createElement('a');\r\n  a.href = url;\r\n  a.download = 'DZO_Dokumenti.zip';\r\n  document.body.appendChild(a);\r\n  a.click();\r\n  window.URL.revokeObjectURL(url);\r\n  document.body.removeChild(a);\r\n};\r\n\r\nexport const downloadExcelClientSide = async (finalResults, folders) => {\r\n  const buildFolderPath = (folderId) => {\r\n    const parts = [];\r\n    const ids = folderId.split('.');\r\n    for (let i = 0; i < ids.length; i++) {\r\n      const pid = ids.slice(0, i + 1).join('.');\r\n      const f = folders.find(x => x.id === pid);\r\n      if (f) parts.push(f.name);\r\n    }\r\n    return parts;\r\n  };\r\n\r\n  // FIX: use getFolderId() to support both direct uploads and AI-classified files\r\n  const sorted = [...finalResults].sort((a, b) =>\r\n    getFolderId(a).localeCompare(getFolderId(b))\r\n  );\r\n\r\n  const grouped = {};\r\n  sorted.forEach(res => {\r\n    const folderId = getFolderId(res);\r\n    const pathArr = buildFolderPath(folderId);\r\n    const topFolder = pathArr[0] || 'Neznano';\r\n    if (!grouped[topFolder]) grouped[topFolder] = [];\r\n    grouped[topFolder].push({ ...res, __pathArr: pathArr });\r\n  });\r\n\r\n  const data = [];\r\n  const styleMap = [];\r\n\r\n  let rowIndex = 0;\r\n\r\n  Object.keys(grouped).sort().forEach((topFolder) => {\r\n    // === MAIN SECTION HEADER ===\r\n    const sectionRow = rowIndex;\r\n    data.push([topFolder, '', '', '', '', '']);\r\n    styleMap.push({ row: sectionRow, type: 'section' });\r\n    rowIndex++;\r\n\r\n    // === TABLE HEADERS ===\r\n    const headerRow = rowIndex;\r\n    data.push([\r\n      'zap. št.',\r\n      'ime dokazila oz. na kaj se dokazilo nanaša',\r\n      'Originalna datoteka',\r\n      'Izdajatelj',\r\n      'št. dokazila',\r\n      'datum'\r\n    ]);\r\n    styleMap.push({ row: headerRow, type: 'header' });\r\n    rowIndex++;\r\n\r\n    // === DATA ROWS ===\r\n    let itemNumber = 1;\r\n    grouped[topFolder].forEach(res => {\r\n      data.push([\r\n        itemNumber++,\r\n        res.documentTitle || '',\r\n        res.originalFileName || res.fileName || '',\r\n        res.issuer || '',\r\n        res.documentNumber || '',\r\n        res.date || ''\r\n      ]);\r\n      rowIndex++;\r\n    });\r\n\r\n    // Empty row separator\r\n    data.push(['', '', '', '', '', '']);\r\n    rowIndex++;\r\n  });\r\n\r\n  const ws = XLSX.utils.aoa_to_sheet(data);\r\n\r\n  // ===== STYLING =====\r\n  styleMap.forEach(info => {\r\n    const cellAddress = XLSX.utils.encode_cell({ r: info.row, c: 0 });\r\n    \r\n    if (info.type === 'section') {\r\n      ws[cellAddress].s = {\r\n        font: { bold: true, sz: 11 },\r\n        alignment: { horizontal: 'left', vertical: 'center' }\r\n      };\r\n    }\r\n    \r\n    if (info.type === 'description') {\r\n      ws[cellAddress].s = {\r\n        font: { italic: true, sz: 9 },\r\n        alignment: { horizontal: 'left', vertical: 'center', wrapText: true }\r\n      };\r\n    }\r\n    \r\n    if (info.type === 'header') {\r\n      for (let col = 0; col < 6; col++) {\r\n        const headerCell = XLSX.utils.encode_cell({ r: info.row, c: col });\r\n        if (ws[headerCell]) {\r\n          ws[headerCell].s = {\r\n            font: { bold: true, sz: 10 },\r\n            alignment: { horizontal: 'center', vertical: 'center' },\r\n            border: {\r\n              top: { style: 'thin', color: { rgb: '000000' } },\r\n              bottom: { style: 'thin', color: { rgb: '000000' } }\r\n            }\r\n          };\r\n        }\r\n      }\r\n    }\r\n  });\r\n\r\n  // Add borders to data rows\r\n  data.forEach((row, rowIdx) => {\r\n    if (styleMap.some(s => s.row === rowIdx)) return;\r\n    \r\n    for (let col = 0; col < 6; col++) {\r\n      const cellAddr = XLSX.utils.encode_cell({ r: rowIdx, c: col });\r\n      if (ws[cellAddr]) {\r\n        ws[cellAddr].s = {\r\n          border: {\r\n            left: { style: 'dotted', color: { rgb: 'CCCCCC' } },\r\n            right: { style: 'dotted', color: { rgb: 'CCCCCC' } },\r\n            bottom: { style: 'dotted', color: { rgb: 'CCCCCC' } }\r\n          }\r\n        };\r\n      }\r\n    }\r\n  });\r\n\r\n  ws['!cols'] = [\r\n    { wch: 8 },\r\n    { wch: 45 },\r\n    { wch: 35 },\r\n    { wch: 30 },\r\n    { wch: 20 },\r\n    { wch: 12 },\r\n    { wch: 5 }\r\n  ];\r\n\r\n  if (!ws['!merges']) ws['!merges'] = [];\r\n  styleMap.forEach(info => {\r\n    if (info.type === 'section' || info.type === 'description') {\r\n      ws['!merges'].push({\r\n        s: { r: info.row, c: 0 },\r\n        e: { r: info.row, c: 5 }\r\n      });\r\n    }\r\n  });\r\n\r\n  const wb = XLSX.utils.book_new();\r\n  XLSX.utils.book_append_sheet(wb, ws, 'Seznam Dokumentov');\r\n  XLSX.writeFile(wb, 'DZO_Dokumenti_Seznam.xlsx');\r\n};"],"names":["addWatermarkToPDF","async","pdfBytes","watermarkText","pdfDoc","PDFDocument","load","pages","getPages","length","page","width","height","getSize","rotation","getRotation","angle","font","embedFont","StandardFonts","HelveticaBold","fontSize","margin","textWidth","widthOfTextAtSize","textHeight","x","y","drawText","size","color","rgb","rotate","degrees","save","error","console","getFolderId","result","_result$suggestedFold","_result$suggestedFold2","suggestedFolder","id","folderId","downloadZipClientSide","finalResults","folders","zip","JSZip","folderPaths","folder","parts","ids","split","i","fid","slice","join","f","find","push","name","path","file","getFileFromIndexedDB","fileName","fileBytes","arrayBuffer","toLowerCase","endsWith","docCode","base","substring","lastIndexOf","ext","newName","concat","String","fileNumber","padStart","folderPath","warn","blob","generateAsync","type","url","window","URL","createObjectURL","a","document","createElement","href","download","body","appendChild","click","revokeObjectURL","removeChild","downloadExcelClientSide","sorted","sort","b","localeCompare","grouped","forEach","res","pathArr","pid","buildFolderPath","topFolder","_objectSpread","__pathArr","data","styleMap","rowIndex","Object","keys","sectionRow","row","headerRow","itemNumber","documentTitle","originalFileName","issuer","documentNumber","date","ws","XLSX","aoa_to_sheet","info","cellAddress","encode_cell","r","c","s","bold","sz","alignment","horizontal","vertical","italic","wrapText","col","headerCell","border","top","style","bottom","rowIdx","some","cellAddr","left","right","wch","e","wb","book_new","book_append_sheet"],"ignoreList":[],"sourceRoot":""}